---
title: "Loading script"
format: html
editor: visual
---

### Clear workspace

```{r}
rm(list = ls())
```

### Import Libraries

```{r}
#| message: false
library("tidyverse")
library("readxl")
```

### Setting the necessary filenames and folder paths

```{r}

raw_data_path <- "~/projects/Group25_Project/_raw"
raw_data_path_barra <- file.path(raw_data_path, "barracoda")
raw_data_path_flow <- file.path(raw_data_path, "flowjo")

data_path <- "~/projects/Group25_Project/data"

file_paths_barra <- list.files(path = raw_data_path_barra,
                    pattern = ".xlsx",
                    full.names = TRUE)

file_paths_flow <- list.files(path = raw_data_path_flow,
                    pattern = ".xls",
                    full.names = TRUE)

outfile_name_barra <- "01_dat_load.csv"
outfile_path_barra <- file.path(data_path, outfile_name_barra)

outfile_name_flow <- "01_dat_flow_load.csv"
outfile_path_flow <- file.path(data_path, outfile_name_flow)

```

### Combining all excel files into one tsv file

Some data included information in the name that could not be found in the file - Eg: not KIR blocked, KIR blocked (\_KIR\_) and KIR double positive (\_KIR_DP)\
Therefore this loading step does not exclusively clean, it also augments the data to some extent.

```{r}
#| message: false
#| warning: false

colnames <- c("barcode", "sample", "count.1", "input.1", "input.2", "input.3", "log_fold_change", "p", "-log10(p)", "masked_p (p = 1 if logFC < 0)", "-log10(masked_p)", "count.normalised (edgeR)", "input.normalised (edgeR)", "Number", "HLA", "Protein", "Peptide")

data_ <- map(file_paths_barra, 
             ~read_excel(.x)) |>          # reading all files into tibbles
        map(~select(.x,
                    all_of(colnames))) |>       # giving all columns names
        map(~filter(.x,
                    row_number() <= n()-1)) |>  # remove last row as it contained a formula
        map(~mutate(.x,                         # fixing a type issue
                    "-log10(masked_p)" = as.numeric(.x[["-log10(masked_p)"]]))) |>
        bind_rows()                             # merging all tibbles into one

```

### Loading FlowJo data

```{r}
#| message: false
#| warning: false

data_flow <- map(file_paths_flow, 
             ~read_excel(.x, col_types = 'text')) |>          # reading all files into tibbles
        map(~rename(.x,
                    experiment = "...1")) |>       # giving all columns names
        map(~filter(.x,
                    row_number() <= n()-2)) |>
        map(~mutate(.x, 
                    across(-experiment,
                           ~as.numeric(str_replace(str_remove(.x, " %"), ",", "."))))) |> 
        bind_rows()
```

### Export loaded data file

```{r}

write_csv(data_, outfile_path_barra)
write_csv(data_flow, outfile_path_flow)
```