---
title: "Augment"
format: html
editor: visual
---

#### Clean Work Environment

```{r}
rm(list = ls())
```

#### Load Packages

```{r}
#| message: false
library(tidyverse)
```

#### Load Data

```{r}
#| message: false

data_path <-  '~/projects/Group25_Project/data'

data_barra <- read_rds(file = file.path(data_path, '02_dat_clean_barracoda.RDS'))
data_flow <- read_rds(file = file.path(data_path, '02_dat_clean_flowjo.RDS'))
outfile_f_path <- file.path(data_path, '03_dat_aug.RDS')
```

### Join Barracoda and Flowjo

Barracoda and flowjo data are joined into one tibble. They do not overlap perfectly, therfore the innerjoin causes some dataloss from both sources.

Then the estimated frequency is calculated as such: $Est.Frequency = (count_{pMHC}/count_{total}) * fraction_{PE positive}$

```{r}

joined_data <- data_barra |>
  inner_join(data_flow, by=c('sample_ID', 'KIR_blocking')) |>
  group_by(sample_ID) |> 
  mutate(total_count = (sum(count, na.rm = TRUE)),
         count_fraction = (count / total_count), # count fraction
         est_frequency = count_fraction*PE_positive)
                
```

### **Adding a "paired" column**

This column is equal to 1 when there is another row with the same sample_ID, cohort, HLA type and peptide, that has the opposite KIR blocking status (blocked = 1, non-blocked = 0).

This means that the same pMHC multimer has been tested in both experiments, i.e. we have paired data.

```{r}
joined_data <- joined_data |> 
  group_by(sample_ID, cohort, HLA, peptide) |>
  mutate(paired =
           factor(
             ifelse((all(c(0, 1) %in% KIR_blocking)), 1, 0)),
         .after = cohort) |>
  ungroup()
```

### Save to csv

```{r}
saveRDS(joined_data, file = outfile_f_path)
```
