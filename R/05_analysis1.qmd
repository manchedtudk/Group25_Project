---
title: "Analysis: Estimated Frequency"
format: html
editor: visual
---

#### Clean Work Environment

```{r}
rm(list = ls())
```

#### Load Packages

```{r}
#| message: false
library(tidyverse)
```

#### Load Data

```{r}
#| message: false
data_barra <- read_rds(file = '~/projects/Group25_Project/data/02_dat_clean_barracoda.RDS')
data_flow <- read_rds(file = '~/projects/Group25_Project/data/02_dat_clean_flowjo.RDS')
```

### Calculate estimated frequency

```{r}
#| warning: false
joined_data <- data_barra |>
               inner_join(data_flow, by=c('sample_ID', 'KIR_blocking'))
```

```{r}
count_flow <- data_barra |> 
              group_by(sample_ID) |> 
              summarise(total_count = sum(count, na.rm = TRUE)) |> 
              right_join(joined_data, by = 'sample_ID')
```

```{r}
count_flow <- count_flow |>
              mutate(count_fraction = (count / total_count)) |> # count fraction
              mutate(Freq = count_fraction*PE_positive)         # Estimated frequency
```

### Filter Data for Plotting

```{r}
plot_data <-  count_flow |>
              filter(KIR_blocking == 0) |>
              filter(p < 0.001 & log_fold_change > 0) |> #p < 0.01 & log_fold_change > 0
              mutate(
                HLA = factor(HLA), # can be removed 
                response = case_when(
                  log_fold_change > 2 ~ 'High',
                  log_fold_change > 1.5 & log_fold_change <= 2 ~ 'Medium',
                  log_fold_change > 1 & log_fold_change <= 1.5 ~ 'Low',
                  TRUE ~ 'No Response'
                )
             )
```

## Plot of logfold change vs epitope binding

```{r}
line_color ='#636363' 
textsize = 10 

```

```{r}
plot_data |> select(peptide, HLA) |> unique()
```

```{r}

ggplot(plot_data, 
       aes( x = peptide, 
            y = log_fold_change, 
            color = protein))+
       facet_grid(cohort ~HLA)+ 
       geom_point(aes(size = Freq), alpha=0.7)+
       scale_size(range = c(0.5, 10)) +
       geom_hline(yintercept = 2, 
                  color= line_color,
                  linetype = 3)+
       geom_hline(yintercept = 0.5, 
                  color= 'black',
                  linewidth = 0.2,
                  linetype = 1)+
       theme_minimal()+
       theme(axis.text.x = element_blank(), 
             panel.margin.x=unit(0.1, "lines"),
             legend.position = 'bottom', #c(0.5, -0.5),
             legend.direction = "horizontal",
             legend.justification = "center",
             panel.grid.major.x = element_blank(),
             panel.grid.minor.x = element_line(color = line_color, linetype = 1, size = 0.2))+
       labs(title='Bubbles', 
             x="pMHC (n = 314)", 
             y="LogFC", 
             color= 'Protein', 
             size='Est.freq.') 
```
